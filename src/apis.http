# üîê API Testing File - NestJS LDAP Hybrid Auth System
# Sistema H√≠brido: LDAP Materialized Path + RBAC
# 
# ‚úÖ Todas las fases completadas y validadas (22/22 tests E2E pasando)
# üìÑ Ver: TODAS_LAS_FASES_COMPLETADAS.md

@host = http://localhost:3000
@superAdminToken = 
@ouAdminToken = 
@userToken = 

###############################################################################
# üèóÔ∏è SETUP INICIAL - Crear Estructura de Prueba
###############################################################################

### SETUP 1: Crear Root DC (Company)
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "company",
  "type": "DC",
  "attributes": {
    "description": "Root Organization"
  }
}

### SETUP 2: Crear Sales OU (bajo Company)
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "sales",
  "type": "OU",
  "parentId": 1, // type: DC (Root), id
  "attributes": {
    "description": "Sales Department"
  }
}

### SETUP 3: Crear Marketing OU (bajo Company)
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "marketing",
  "type": "OU",
  "parentId": 1,
  "attributes": {
    "description": "Marketing Department"
  }
}

### SETUP 4: Crear SUPER_ADMIN User
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "superadmin",
  "type": "USER",
  "password": "admin123",
  "parentId": 1, // type: OU (marketing), id: 2
  "attributes": {
    "email": "superadmin@company.com",
    "isSuperAdmin": true
  }
}

### SETUP 5: Crear Sales Admin (OU_ADMIN)
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "sales.admin",
  "type": "USER",
  "password": "salesadmin123",
  "parentId": 2,
  "attributes": {
    "email": "sales.admin@company.com",
    "isAdmin": true,
    "adminOf": "2"
  }
}

### SETUP 6: Crear Sales User
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "sales.user",
  "type": "USER",
  "password": "user123",
  "parentId": 2,
  "attributes": {
    "email": "sales.user@company.com"
  }
}

### SETUP 7: Crear Marketing User
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "marketing.user",
  "type": "USER",
  "password": "user123",
  "parentId": 3,
  "attributes": {
    "email": "marketing.user@company.com"
  }
}

###############################################################################
# üîë AUTENTICACI√ìN - Obtener Tokens
###############################################################################

### AUTH 1: Login como SUPER_ADMIN
# @name loginSuperAdmin
POST {{host}}/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "superadmin",
  "password": "admin123"
}

### AUTH 2: Login como OU_ADMIN (Sales)
# @name loginOuAdmin
POST {{host}}/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "sales.admin",
  "password": "salesadmin123"
}

### AUTH 3: Login como USER (Sales)
# @name loginUser
POST {{host}}/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "sales.user",
  "password": "user123"
}

###############################################################################
# ‚úÖ FASE 2: RBAC EST√ÅNDAR - Public vs Private (7/7 tests ‚úÖ)
###############################################################################

### FASE 2.1: ‚ùå GET sin token ‚Üí 401 Unauthorized
GET {{host}}/directory/tree HTTP/1.1

### FASE 2.2: ‚ùå POST sin token ‚Üí 401 Unauthorized
POST {{host}}/directory HTTP/1.1
Content-Type: application/json

{
  "name": "unauthorized.node",
  "type": "OU",
  "parentId": 1
}

### FASE 2.3: ‚ùå MOVE sin token ‚Üí 401 Unauthorized
POST {{host}}/directory/move HTTP/1.1
Content-Type: application/json

{
  "nodeId": 6,
  "newParentId": 3
}

### FASE 2.4: ‚ùå DELETE sin token ‚Üí 401 Unauthorized
DELETE {{host}}/directory/6 HTTP/1.1

### FASE 2.5: ‚ùå USER intenta CREATE ‚Üí 403 Forbidden
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "name": "unauthorized.node",
  "type": "OU",
  "parentId": 2
}

### FASE 2.6: ‚ùå USER intenta MOVE ‚Üí 403 Forbidden
POST {{host}}/directory/move HTTP/1.1
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "nodeId": 6,
  "newParentId": 3
}

### FASE 2.7: ‚ùå USER intenta DELETE ‚Üí 403 Forbidden
DELETE {{host}}/directory/6 HTTP/1.1
Authorization: Bearer {{userToken}}

###############################################################################
# ‚úÖ FASE 3: TEST MATRIX - Hierarchical Access Control (6/6 tests ‚úÖ)
###############################################################################

### FASE 3.1: ‚úÖ SUPER_ADMIN puede acceder a cualquier nodo
GET {{host}}/directory/7 HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### FASE 3.2: ‚úÖ OU_ADMIN puede acceder dentro de su branch
GET {{host}}/directory/6 HTTP/1.1
Authorization: Bearer {{ouAdminToken}}

### FASE 3.3: ‚ùå OU_ADMIN NO puede acceder fuera de su branch (Marketing)
GET {{host}}/directory/7 HTTP/1.1
Authorization: Bearer {{ouAdminToken}}

### FASE 3.4: ‚ùå OU_ADMIN NO puede editar nodo ancestro (Root)
GET {{host}}/directory/1 HTTP/1.1
Authorization: Bearer {{ouAdminToken}}

### FASE 3.5: ‚úÖ USER puede leer el √°rbol completo
GET {{host}}/directory/tree HTTP/1.1
Authorization: Bearer {{userToken}}

### FASE 3.6: ‚ùå USER NO puede DELETE (falta rol ADMIN)
DELETE {{host}}/directory/6 HTTP/1.1
Authorization: Bearer {{userToken}}

###############################################################################
# ‚úÖ FASE 4: ANTI-ESCALATION SECURITY (6/6 tests ‚úÖ)
###############################################################################

### FASE 4.1: ‚ùå OU_ADMIN NO puede mover su propio nodo a Root
POST {{host}}/directory/move HTTP/1.1
Authorization: Bearer {{ouAdminToken}}
Content-Type: application/json

{
  "nodeId": 5,
  "newParentId": 1
}

### FASE 4.2: ‚ùå OU_ADMIN NO puede mover nodos fuera de su scope
POST {{host}}/directory/move HTTP/1.1
Authorization: Bearer {{ouAdminToken}}
Content-Type: application/json

{
  "nodeId": 6,
  "newParentId": 3
}

### FASE 4.3: ‚ùå OU_ADMIN NO puede crear nodo fuera de su scope
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{ouAdminToken}}
Content-Type: application/json

{
  "name": "phantom.user",
  "type": "USER",
  "parentId": 3,
  "password": "password123",
  "attributes": {
    "email": "phantom@company.com"
  }
}

### FASE 4.4: ‚úÖ OU_ADMIN PUEDE crear nodo dentro de su scope
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{ouAdminToken}}
Content-Type: application/json

{
  "name": "new.sales.user",
  "type": "USER",
  "parentId": 2,
  "password": "password123",
  "attributes": {
    "email": "new.sales@company.com"
  }
}

### FASE 4.5: ‚ùå OU_ADMIN NO puede crear usuario con rol SUPER_ADMIN
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{ouAdminToken}}
Content-Type: application/json

{
  "name": "fake.superadmin",
  "type": "USER",
  "parentId": 2,
  "password": "password123",
  "attributes": {
    "isSuperAdmin": true,
    "email": "fake.superadmin@company.com"
  }
}

### FASE 4.6: ‚úÖ SUPER_ADMIN PUEDE crear usuario con cualquier rol
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "new.admin",
  "type": "USER",
  "parentId": 2,
  "password": "password123",
  "attributes": {
    "isAdmin": true,
    "adminOf": "2",
    "email": "new.admin@company.com"
  }
}

###############################################################################
# ‚úÖ FASE 5: AUDIT TRAIL (3/3 tests ‚úÖ)
###############################################################################

### FASE 5.1: ‚úÖ OU_ADMIN modifica usuario en su scope (debe loggearse)
GET {{host}}/directory/6 HTTP/1.1
Authorization: Bearer {{ouAdminToken}}

### FASE 5.2: ‚úÖ SUPER_ADMIN realiza acci√≥n administrativa (debe loggearse)
GET {{host}}/directory/7 HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### FASE 5.3: ‚úÖ USER realiza operaci√≥n de solo lectura (NO debe loggearse)
GET {{host}}/directory/tree HTTP/1.1
Authorization: Bearer {{userToken}}

###############################################################################
# üîç B√öSQUEDAS AVANZADAS
###############################################################################

### SEARCH 1: B√∫squeda en Sub-√°rbol (Scoped Search)
# Buscar dentro de Sales y todos sus sub-departamentos
GET {{host}}/directory/scope/2?q=user HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### SEARCH 2: B√∫squeda Plana (Global Search)
# Buscar en TODO el directorio ignorando jerarqu√≠a
GET {{host}}/directory/search/flat?q=admin HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### SEARCH 3: B√∫squeda Plana con filtro de tipo
GET {{host}}/directory/search/flat?q=sales&type=USER HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### SEARCH 4: Obtener Ancestros (Breadcrumbs)
# Obtener la ruta completa de un usuario
GET {{host}}/directory/6/ancestors HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### SEARCH 5: Ver √Årbol Completo
GET {{host}}/directory/tree HTTP/1.1
Authorization: Bearer {{superAdminToken}}

### SEARCH 6: Obtener nodo espec√≠fico por ID
GET {{host}}/directory/2 HTTP/1.1
Authorization: Bearer {{superAdminToken}}

###############################################################################
# üîÑ OPERACIONES AVANZADAS
###############################################################################

### ADVANCED 1: Mover Usuario entre Departamentos (dentro del scope)
POST {{host}}/directory/move HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "nodeId": 6,
  "newParentId": 3
}

### ADVANCED 2: Crear Sub-departamento
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "sales.team.a",
  "type": "OU",
  "parentId": 2,
  "attributes": {
    "description": "Sales Team A",
    "manager": "sales.admin@company.com"
  }
}

### ADVANCED 3: Crear usuario en sub-departamento
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "team.a.user",
  "type": "USER",
  "password": "password123",
  "parentId": 8,
  "attributes": {
    "email": "team.a.user@company.com",
    "firstName": "Team A",
    "lastName": "User"
  }
}

###############################################################################
# ‚ùå VALIDACIONES - Casos que DEBEN FALLAR
###############################################################################

### VALIDATION 1: ‚ùå Intentar crear hijo de USER (debe fallar)
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "invalid.child",
  "type": "OU",
  "parentId": 6,
  "attributes": {}
}

### VALIDATION 2: ‚ùå Nombre duplicado entre hermanos (debe fallar)
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "sales.user",
  "type": "USER",
  "parentId": 2,
  "password": "pass123"
}

### VALIDATION 3: ‚ùå Parent ID inv√°lido (debe fallar)
POST {{host}}/directory HTTP/1.1
Authorization: Bearer {{superAdminToken}}
Content-Type: application/json

{
  "name": "orphan.user",
  "type": "USER",
  "parentId": 9999,
  "password": "pass123"
}

###############################################################################
# üè• HEALTH & MONITORING
###############################################################################

### Health Check
GET {{host}}/ HTTP/1.1

### Swagger Documentation
# GET {{host}}/docs

### Swagger JSON
# GET {{host}}/docs-json

###############################################################################
# üìä ESTRUCTURA DE √ÅRBOL RESULTANTE
###############################################################################
#
# company (OU) - ID: 1 - mpath: "1."
# ‚îú‚îÄ‚îÄ sales (OU) - ID: 2 - mpath: "1.2."
# ‚îÇ   ‚îú‚îÄ‚îÄ sales.admin (USER - OU_ADMIN) - ID: 5 - mpath: "1.2.5."
# ‚îÇ   ‚îú‚îÄ‚îÄ sales.user (USER) - ID: 6 - mpath: "1.2.6."
# ‚îÇ   ‚îî‚îÄ‚îÄ sales.team.a (OU) - ID: 8 - mpath: "1.2.8."
# ‚îÇ       ‚îî‚îÄ‚îÄ team.a.user (USER) - ID: 9 - mpath: "1.2.8.9."
# ‚îÇ
# ‚îú‚îÄ‚îÄ marketing (OU) - ID: 3 - mpath: "1.3."
# ‚îÇ   ‚îî‚îÄ‚îÄ marketing.user (USER) - ID: 7 - mpath: "1.3.7."
# ‚îÇ
# ‚îî‚îÄ‚îÄ superadmin (USER - SUPER_ADMIN) - ID: 4 - mpath: "1.4."
#
###############################################################################

###############################################################################
# üéØ CASOS DE USO POR ROL
###############################################################################

# üî¥ SUPER_ADMIN (superadmin)
# ‚úÖ Puede acceder a CUALQUIER nodo
# ‚úÖ Puede crear en CUALQUIER lugar
# ‚úÖ Puede mover CUALQUIER nodo
# ‚úÖ Puede otorgar CUALQUIER rol
# ‚úÖ NO tiene restricciones de scope

# üü° OU_ADMIN (sales.admin)
# ‚úÖ Puede acceder a nodos dentro de Sales (mpath: "1.2.*")
# ‚úÖ Puede crear usuarios en Sales
# ‚úÖ Puede mover nodos dentro de Sales
# ‚ùå NO puede acceder a Marketing
# ‚ùå NO puede acceder a nodos ancestros (company)
# ‚ùå NO puede mover nodos fuera de Sales
# ‚ùå NO puede otorgar rol SUPER_ADMIN

# üü¢ USER (sales.user)
# ‚úÖ Puede leer el √°rbol completo
# ‚úÖ Puede buscar en el directorio
# ‚ùå NO puede crear nodos
# ‚ùå NO puede mover nodos
# ‚ùå NO puede eliminar nodos

###############################################################################
# üìù NOTAS IMPORTANTES
###############################################################################

# 1. Tokens JWT:
#    - Expiran en 1h en producci√≥n
#    - Expiran en 24h en tests (NODE_ENV=test)
#    - Contienen: id, role, roles, mpath, adminOfNodeId

# 2. Materialized Path (mpath):
#    - Formato: "1.2.3." (cada n√∫mero es un ID de nodo)
#    - Permite queries O(1) para validaci√≥n jer√°rquica
#    - Se genera autom√°ticamente por TypeORM

# 3. Roles:
#    - SUPER_ADMIN: Acceso total sin restricciones
#    - OU_ADMIN: Acceso limitado a su OU y descendientes
#    - USER: Solo lectura

# 4. Validaciones de Seguridad:
#    - Previene escalamiento de privilegios
#    - Previene creaci√≥n fantasma (fuera de scope)
#    - Previene auto-promoci√≥n
#    - Previene acceso a ancestros

# 5. Tests E2E:
#    - 22/22 tests pasando (100%)
#    - Ver: test/auth-tasks-validation.e2e-spec.ts
#    - Ejecutar: pnpm test:e2e

###############################################################################